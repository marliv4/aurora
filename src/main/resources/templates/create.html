<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/index}">aurora</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
                <a class="nav-link" th:href="@{create}">create</a>
                <a class="nav-link" th:href="@{publish}">publish</a>
                <a class="nav-link" th:href="@{/register}">register</a>
                <a class="nav-link" th:href="@{/login}">login</a>
                <a class="nav-link" th:href="@{/profile}">my profile</a>
                <a class="nav-link">logout</a>
            </div>
        </div>
    </div>
</nav>
    <label for="file">Choose a file:</label><br>
    <input type="file" id="file" name="file" accept="image/gif,image/x-png"><br><br>
    <button id="uploadButton">upload</button>
    <button id="renderButton">render</button>
    <label for="customRange2" class="form-label">Example range</label>
    <input type="range" class="form-range" min="0" max="5" id="customRange2">

    <canvas id="canvas"></canvas>
    <progress id="progress" value="0" max="1" style="display:none"></progress>

    <script th:src="@{js/omggif.js}"></script>
    <script th:src="@{js/three.min.js}"></script>
    <script>
        function uploadImg() {
            const fileInput = document.getElementById("file").value;
            alert(fileInput);
        }

        const canvas = document.getElementById("canvas");
        function generateGIF(element, renderFunction, duration = 1, fps = 30) {
            const frames = duration * fps;

            const canvas = document.createElement( 'canvas' );
            canvas.width = element.width;
            canvas.height = element.height;
            const context = canvas.getContext( '2d' );

            const buffer = new Uint8Array( canvas.width * canvas.height * frames * 5 );
            const pixels = new Uint8Array( canvas.width * canvas.height );
            const writer = new GifWriter( buffer, canvas.width, canvas.height, { loop: 0 } );

            let current = 0;

            return new Promise(async function addFrame(resolve) {
                console.log(context === null);
                renderFunction(current / frames);
                context.drawImage(element, 0, 0);

                const data = context.getImageData(0, 0, canvas.width, canvas.height).data;

                const palette = [];

                for (var j = 0, k = 0, jl = data.length; j < jl; j += 4, k++) {

                    const r = Math.floor(data[ j + 0 ] * 0.1) * 10;
                    const g = Math.floor(data[ j + 1 ] * 0.1) * 10;
                    const b = Math.floor(data[ j + 2 ] * 0.1) * 10;
                    const color = r << 16 | g << 8 | b << 0;

                    const index = palette.indexOf(color);

                    if (index === -1) {
                        pixels[k] = palette.length;
                        palette.push(color);

                    } else {
                        pixels[k] = index;
                    }

                }

                let powof2 = 1;
                while (powof2 < palette.length) powof2 <<= 1;
                palette.length = powof2;


                const delay = 100 / fps; // Delay in hundredths of a sec (100 = 1s)
                const options = { palette: new Uint32Array( palette ), delay: delay };
                writer.addFrame( 0, 0, canvas.width, canvas.height, pixels, options );

                current ++;

                progress.value = current / frames;

                if ( current < frames ) {
                    await setTimeout(addFrame, 0, resolve);
                } else {
                    resolve(buffer.subarray(0, writer.end()));
                }
            } );

        }

        const renderButton = document.getElementById('renderButton');
        const progress = document.getElementById( 'progress');

        renderButton.addEventListener( 'click', async function () {
            renderButton.style.display = 'none';
            progress.style.display = '';

            const buffer = await generateGIF(canvas, render, 4, 30);

            renderButton.style.display = '';
            progress.style.display = 'none';
            // Download

            const blob = new Blob( [ buffer ], { type: 'image/gif' } );

            const link = document.createElement( 'a' );
            link.href = URL.createObjectURL( blob );
            link.download = 'animation.gif';
            link.dispatchEvent( new MouseEvent( 'click' ) );
        } );

        // Animation
        const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 10);
        camera.position.z = 2;

        const scene = new THREE.Scene();

        const geometry = new THREE.IcosahedronGeometry(0.75, 1);
        const material = new THREE.MeshNormalMaterial({ flatShading: true });
        const mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);

        const renderer = new THREE.WebGLRenderer( { canvas: canvas } );
        renderer.setClearColor(0xffffff, 1);
        renderer.setSize(500, 500);
        document.body.appendChild(renderer.domElement);
        //

        function render(progress) {
            // progress goes from 0 to 1
            mesh.rotation.x = progress * Math.PI * 2;
            mesh.rotation.y = - progress * Math.PI * 2;

            renderer.render(scene, camera);
        }

        function animation(time) {
            if (progress.style.display === 'none' ) {
                render( (time / 5000) % 1);
            }

            requestAnimationFrame( animation );
        }

        requestAnimationFrame(animation);

        document.getElementById("uploadButton").addEventListener("click", uploadImg);
    </script>
</body>
</html>